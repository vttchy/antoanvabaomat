generator client {
  provider           = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}


// User and related domain models
enum Role {
  Admin
  User
}

model User {
  id               String         @id @default(auto()) @map("_id") @db.ObjectId
  firstName        String
  lastName         String
  birthday         DateTime?
  gender           String?
  email            String         @unique
  password         String?
  role             Role 
  externalId       String?
  provider         String?
  phoneNumber      String?
  isActive         Boolean        @default(false)
  addresses        Address[]
  wishlist         Wishlist?      @relation("UserToWishlist")
  cart             Cart?          @relation("UserToCart")
  orders           Order[]        @relation("UserToOrders")
  reviews          Review[]       @relation("UserToReviews")
  sentMessages     ChatMessage[]  @relation("SentMessages")
  receivedMessages ChatMessage[]  @relation("ReceivedMessages")
  vouchers   VoucherWithUser[]
}

model Address {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  firstName    String
  lastName    String
  phoneNumber String
  location   String
  isDefault   Boolean  @default(false)
  user        User     @relation(fields: [userId], references: [id])
  orders      Order[]  @relation("OrderToShippingAddress")
}



// Catalog and Product domain models
model Category {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  description   String?
  isActive      Boolean       @default(true)
  subcategories Subcategory[]
}

model Subcategory {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  categoryId  String    @db.ObjectId
  name        String
  description String?
  isActive    Boolean   @default(true)
  category    Category  @relation(fields: [categoryId], references: [id])
  products    Product[]
}

model Product {
  id              String           @id @default(auto()) @map("_id") @db.ObjectId
  subcategoryId   String           @db.ObjectId
  name            String
  description     String?
  price           Float
  discountedPrice Float?
  stockQuantity   Int
  imageUrl        String?
  createdAt       DateTime         @default(now())
  isActive        Boolean          @default(true)
  productCode     String           @unique
  subcategory     Subcategory      @relation(fields: [subcategoryId], references: [id])
  productVariants ProductVariant[]

  sizes           Json?            
  colors          Json?
  reviews         Review[]         @relation("ProductToReviews")
  wishlistDetails       WishlistDetailt[]   @relation("WishlistDetailToProduct")
  productImages          ProductImage[]
}

model ProductVariant {
  id                     String         @id @default(auto()) @map("_id") @db.ObjectId
  productId              String         @db.ObjectId
  size               String         
  color              String         
  stockQuantity          Int
  variantPrice           Float?
  variantDiscountedPrice Float?
  variantImageUrl        String?
  isActive               Boolean        @default(true)
  product                Product        @relation(fields: [productId], references: [id])
  createdAt       DateTime         @default(now())
  cartDetails            CartDetail[]   @relation("CartDetailToProductVariant")
  orderDetails           OrderDetail[]  @relation("OrderDetailToProductVariant")
}

model ProductImage {
  id               String        @id @default(auto()) @map("_id") @db.ObjectId
  productId String        @db.ObjectId
  imageUrl         String
  product   Product @relation(fields: [productId], references: [id])
}




// cart and Raorder domain models
model Cart {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  userId        String      @db.ObjectId @unique
  user          User        @relation("UserToCart", fields: [userId], references: [id])
  createdAt     DateTime    @default(now())
  cartDetails   CartDetail[] @relation("CartToCartDetails")
}

model CartDetail {
  id               String        @id @default(auto()) @map("_id") @db.ObjectId
  cartId           String        @db.ObjectId
  cart             Cart          @relation("CartToCartDetails", fields: [cartId], references: [id])
  productVariantId String        @db.ObjectId
  productVariant   ProductVariant @relation("CartDetailToProductVariant", fields: [productVariantId], references: [id])
  quantity         Int
  unitPrice        Float
}

model Wishlist {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String      @db.ObjectId @unique
  user          User        @relation("UserToWishlist", fields: [userId], references: [id])
  createdAt     DateTime    @default(now())
  wishlistDetailts   WishlistDetailt[] @relation("WishlistToWishlistDetails")
}

model WishlistDetailt{
  id               String        @id @default(auto()) @map("_id") @db.ObjectId
  wishlistId           String        @db.ObjectId
  wishlist             Wishlist          @relation("WishlistToWishlistDetails", fields: [wishlistId], references: [id])
  productId String        @db.ObjectId
  product   Product @relation("WishlistDetailToProduct", fields: [productId], references: [id])
}

model Order {
  id                String        @id @default(auto()) @map("_id") @db.ObjectId
  userId            String        @db.ObjectId
  orderDate         DateTime      @default(now())
  totalAmount       Float
  status            OrderStatus   @default(Pending)
  shippingAddressId String        @db.ObjectId
  shippingCost     Float
  paymentMethodId   String        @db.ObjectId
  couponId          String?       @db.ObjectId 
  discountApplied   Float         @default(0)
  discountAppliedType  PromotionalType?
  notes             String?       

  user              User          @relation("UserToOrders", fields: [userId], references: [id])
  shippingAddress   Address       @relation("OrderToShippingAddress", fields: [shippingAddressId], references: [id])
  paymentMethod     PaymentMethod @relation("PaymentMethodToOrders", fields: [paymentMethodId], references: [id])
  coupon            Coupon?       @relation(fields: [couponId], references: [id]) 
  orderDetails      OrderDetail[] @relation("OrderToOrderDetails")
  payments          Payment?     @relation("OrderToPayment")
}

model OrderDetail {
  id               String        @id @default(auto()) @map("_id") @db.ObjectId
  orderId          String        @db.ObjectId
  
  productVariantId String        @db.ObjectId
  
  quantity         Int
  unitPrice        Float
  subtotal         Float
  order            Order         @relation("OrderToOrderDetails", fields: [orderId], references: [id])
  productVariant   ProductVariant @relation("OrderDetailToProductVariant", fields: [productVariantId], references: [id])
}

enum OrderStatus {
  Pending
  Confirmed
  Processing
  Shipped
  Delivered
  Cancelled
}



// chat domain models
model ChatMessage {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  senderId   String    @db.ObjectId
  sender     User      @relation("SentMessages", fields: [senderId], references: [id])
  receiverId String    @db.ObjectId
  receiver   User      @relation("ReceivedMessages", fields: [receiverId], references: [id])
  content    String
  filePath   String?
  sentAt     DateTime  @default(now())
  isRead     Boolean   @default(false)
}


//payment domain models
model Payment {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  orderId         String        @db.ObjectId @unique
  paymentMethodId String        @db.ObjectId
  amount          Float
  paymentDate     DateTime      @default(now())
  status          Boolean       @default(false)       
  transactionId   String?       
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  order           Order?        @relation("OrderToPayment", fields: [orderId], references: [id])
  paymentMethod   PaymentMethod @relation(fields: [paymentMethodId], references: [id])
}

model PaymentMethod {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  name        String   
  description String?   
  isActive    Boolean   @default(true)
  type        PaymentType
  payments    Payment[]
  order       Order[]         @relation("PaymentMethodToOrders")
}

enum PaymentType {
  COD
  VNPAY
  MOMO
  ZALOPAY
  BANK_TRANSFER
}

model Coupon {
  id               String    @id @default(auto()) @map("_id") @db.ObjectId
  code             String    @unique
  promotionalType   PromotionalType
  discountType    DiscountType
  discountValue   Float
  startDate        DateTime
  endDate          DateTime
  maxUsage         Int
  isActive         Boolean   @default(true)
  orders           Order[]
  users            VoucherWithUser[]
}

enum PromotionalType {
  SHIPPING
  PRODUCT
}
enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

model VoucherWithUser {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  couponId   String   @db.ObjectId
  isUse     Boolean  @default(false)
  user       User     @relation(fields: [userId], references: [id])
  coupon     Coupon   @relation(fields: [couponId], references: [id])
}

// Review domain model
model Review {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  productId String    @db.ObjectId
  product   Product   @relation("ProductToReviews", fields: [productId], references: [id])
  userId    String    @db.ObjectId
  user      User      @relation("UserToReviews", fields: [userId], references: [id])
  rating    Rating
  comment   String?   
  createdAt DateTime  @default(now())
}

//token domain model
model VerifiToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String
  token     String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model PasswordResetToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String
  token     String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

enum Rating {
  ONE
  ONE_HALF
  TWO
  TWO_HALF
  THREE
  THREE_HALF
  FOUR
  FOUR_HALF
  FIVE
}
